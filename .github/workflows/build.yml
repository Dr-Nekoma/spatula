name: "Nix"
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Nix Build
    steps:
    - uses: actions/checkout@v3
    - uses: cachix/install-nix-action@v18
      with:
        extra_nix_config: |
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    - name: Nix Build
      run: |
        nix build
    # NOTE: Workaround for this issue https://github.com/actions/upload-artifact/issues/92
    - name: Copy binary artifacts
      run: |
        mkdir build && cp -r result/* build/ && chmod +w -R build/
        chmod 744 build/bin/spatula-exe
    # NOTE: Another workaround https://github.com/actions/upload-artifact#maintaining-file-permissions-and-case-sensitive-files
    - name: Tar files
      run: tar cvf spatula.tar build/bin
    - name: "Upload artifact to github"
      uses: actions/upload-artifact@v3
      with:
        name: spatula-tar
        path: spatula.tar

  test-bin:
    runs-on: ubuntu-latest
    name: Spatula / ${{ matrix.example }}
    needs: [build]
    strategy:
      matrix:
        # Run the following to re-generate this list
        # ls -L1 examples/*.sw | sed 's!.*/!!' | sort | tr '\n' ", " | sed 's/\.sw//g' | sed 's/.$//'
        example: [ADT,Alias,Comment,Factorial,Filter,Fold,Forall,Functions,Funs,Fun,IO,List,Map,Multiple,Print,Progn,Read,Record,Sum]
        excluded:
          # Add any examples that are not fully supported here
          - example: ADT

    steps:
    - uses: actions/checkout@v3
    - uses: actions/download-artifact@v3
      with:
        name: spatula-tar
        path: spatula.tar
    - name: Run binaries
      run: |
        tar xvf spatula.tar
        ls -lah
        ./build/bin/spatula-exe -f $(pwd)/examples/${{ matrix.example }}.sw
